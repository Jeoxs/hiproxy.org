<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>hiproxy简介 - hiproxy</title>
         <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome-4.5.0.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet"> 
        <link href="../../css/custom.css" rel="stylesheet"> 
        <!-- <link rel="stylesheet" href="../../spectre.min.css"> -->
        <link rel="stylesheet" href="../../css/highlight.css">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
	
	<script src="../../js/jquery-1.10.2.min.js"></script>
        <script src="../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../js/highlight.pack.js"></script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="../..">hiproxy</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                    <li >
                        <a href="../..">首页</a>
                    </li>
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">快速开始 <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li class="active">
    <a href="./">hiproxy简介</a>
</li>
                            
<li >
    <a href="../installation/">安装</a>
</li>
                            
<li >
    <a href="../run_example/">运行示例项目</a>
</li>
                            
<li >
    <a href="../applied_to_existing_projects/">运用到现有项目</a>
</li>
                            
<li >
    <a href="../cli_options/">CLI选项</a>
</li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">配置 <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li >
    <a href="../../configuration/introduction/">简介</a>
</li>
                            
<li >
    <a href="../../configuration/find_conf/">配置文件查找</a>
</li>
                            
<li >
    <a href="../../configuration/hosts/">hosts</a>
</li>
                            
<li >
    <a href="../../configuration/rewrite/">rewrite</a>
</li>
                            
<li >
    <a href="../../configuration/ssl_certificate/">SSL/TLS证书配置</a>
</li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Rewrite <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li >
    <a href="../../configuration/rewrite_introduction/">简介</a>
</li>
                            
<li >
    <a href="../../configuration/rewrite_scope/">作用域</a>
</li>
                            
<li >
    <a href="../../configuration/rewrite_directive/">内置指令</a>
</li>
                            
<li >
    <a href="../../configuration/rewrite_built_in_variable/">内置变量</a>
</li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Node.js API <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li >
    <a href="../../api/api/">API</a>
</li>
                            
<li >
    <a href="../../api/events/">事件</a>
</li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">开发者 <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li >
    <a href="../../developer/plugin/">插件机制</a>
</li>
                            
<li >
    <a href="../../developer/cli_command/">扩展CLI命令</a>
</li>
                            
<li >
    <a href="../../developer/directive/">扩展指令</a>
</li>
                            
<li >
    <a href="../../developer/route/">扩展页面</a>
</li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">常见问题 <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li >
    <a href="../../faqs/">FAQs</a>
</li>
                        </ul>
                    </li>
                </ul>

            <ul class="nav navbar-nav navbar-right">
                <!-- <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li> -->
                    <!-- <li >
                        <a rel="next" href="../..">
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../installation/">
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li> -->
                    <li>
                        <a href="https://github.com/hiproxy/hiproxy">
                                <i class="fa fa-github"></i>&nbsp;GitHub
                        </a>
                    </li>
            </ul>
        </div>
    </div>
</div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#introduction">Introduction</a></li>
            <li><a href="#hiproxy">为什么要开发hiproxy</a></li>
            <li><a href="#_1">特色</a></li>
            <li><a href="#_2">理念</a></li>
            <li><a href="#_3">基本原理</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="introduction">Introduction</h1>
<blockquote>
<p>如果你愿意帮助hiproxy编写文档，请联系zdying@live.com, 谢谢！</p>
<p>If you are willing to help hiproxy to write documentation, please contact zdying@live.com, thank you!</p>
</blockquote>
<p>hiproxy是一个基于Node.js开发的轻量、可扩展的网络代理工具，主要目的是为了解决多个开发者在开发过程中遇到的hosts管理和请求代理的问题。使得在开发时，不再需要修改系统hosts和启动一个Nginx服务。</p>
<p>hiproxy支持hosts配置文件，同时也扩展了hosts的语法，支持端口号。此外，hiproxy还支跟Nginx配置文件相似语法的配置文件。</p>
<h2 id="hiproxy">为什么要开发hiproxy</h2>
<p>在前端开发中，如果我们通常会遇到下面的一些问题：</p>
<ol>
<li>调试线上页面问题，要在本地进行开发，需要能运行后端的项目（Node.js或者Java等项目），<strong>前端工程师在本地搭建一套后端环境，可能代价比较大</strong>。</li>
<li>如果有多个前端工程，<strong>采用一个域名</strong>，<strong>部分工程</strong> 需要请求 <strong>线上</strong> 资源，<strong>部分</strong> 工程请求 <strong>本地</strong>。</li>
<li>为解决跨域等问题，本地开发时需要 <strong>修改Response Header</strong>。</li>
<li>本地开发https站点时，<strong>证书不受信任</strong>。</li>
<li>系统 <strong>hosts修改</strong> 后，<strong>不会立即生效</strong>。</li>
</ol>
<p>我们可以使用Nginx来解决上面的问题。Nginx很优秀，也是我们前端开发工程师的一个非常好的朋友。Nginx的配置文件风格，非常直观，编写配置效率很高。</p>
<p>但是，使用Nginx的时候，我们同时需要使用hosts，把相关请求发送到本地的Nginx服务。</p>
<p>此外，大部分情况下，Nginx的配置文件并不会被提交到代码仓库，所以团队中其他开发者之间会互相拷贝配置文件，这样效率比较低，而且一个人修改了配置文件，其他人的配置不会随之更新。对于多个域名的配置，也都是放到一个统一的目录，然后在主配置里面include，这样也不太方便。</p>
<p><strong>hosts</strong>、<strong>反向代理</strong>、<strong>https</strong> 和 <strong>缓存</strong> 这些琐碎的事情，能不能统一解决？</p>
<p>于是有了hiproxy。</p>
<h2 id="_1">特色</h2>
<ul>
<li>支持Nginx风格的配置文件格式，配置简单直观</li>
<li>支持hosts以及扩展（支持端口号）</li>
<li>支持插件扩展rewrite指令、CLI命令和页面</li>
<li>支持HTTPS证书自动生成</li>
<li>支持代理自动配置（Proxy auto-config）</li>
<li>支持后台启动，日志输出到文件</li>
<li>支持配置文件自动查找</li>
<li>支持打开浏览器窗口并自动配置代理</li>
<li>提供Node.js API</li>
<li>...</li>
</ul>
<h2 id="_2">理念</h2>
<p>我们经过对很多现有开发模式的反思、总结现在遇到的一些问题，基于以下两个理念开发出了hiproxy：</p>
<ul>
<li><strong>工作空间</strong>：hiproxy工作在工作空间（workspace）中，工作空间中所有项目的配置文件都会被hiproxy解析。<em>工作空间可以通过<code>-w, --workspace &lt;workspace&gt;</code>来指定，也可以直接进入到工作空间启动代理服务</em>。</li>
<li><strong>配置文件共享</strong>：配置文件，提交到代码仓库，团队成员共享配置。之前hosts和Nginx配置一般都是不提交到代码仓库，团队成员各自本地维护，成本大并且效率比较低。</li>
</ul>
<h2 id="_3">基本原理</h2>
<p>hiproxy的核心功能是请求代理，在代理请求的同时，处理了一些开发中的细节问题，比如https证书自动生成、自动配置浏览器代理等。</p>
<p>下面讲介绍hiproxy核心功能的基本原理。</p>
<h3 id="_4">请求代理</h3>
<p>hiproxy充分利用了<a href="https://en.wikipedia.org/wiki/Man-in-the-middle_attack">中间人攻击</a>模式，作为中间人在客户端和服务器端转发数据，来实现HTTP以及HTTPS请求的代理。</p>
<h4 id="http">HTTP请求代理</h4>
<p>对于<strong>HTTP请求</strong>，如果浏览器配置了代理，浏览器会发送<code>GET</code>/<code>POST</code>等请求给hiproxy代理。hiproxy收到请求之后，根据用户的<code>hosts</code>和<code>rewrite</code>规则配置，对请求的信息做一定的修改，然后去相应的服务器请求资源并返回给客户端。</p>
<h4 id="https">HTTPS请求代理</h4>
<p>对于<strong>HTTPS请求</strong>，配置代理之后，浏览器会发送<code>CONNECT</code>请求到hiproxy服务，hiproxy会新建一个到最终目标服务器的TCP连接（也就是新建了一个隧道）然后在客户端和服务端之间转发数据。</p>
<p>但是这只是能简单代理请求，hiproxy没办法获取到请求的信息，比如参数和Cookie，更没有办法修改响应的数据。如果不需要对请求、响应的信息做对应的修改，这就能满足我们的需求。</p>
<p>如果我们需要实现跟HTTP请求一样的功能：根据请求的信息，对请求和响应做一些修改，需要怎么做呢？</p>
<p>好在我们可以充分利用<a href="https://en.wikipedia.org/wiki/Man-in-the-middle_attack">中间人攻击</a>这种模式。因为最终的目标服务器能获取到请求的信息，我们可以在hiproxy和最终服务器之间再启动一个中间人服务（这里简称为<em>M</em>），当hiproxy收到<code>CONNECT</code>请求之后，新建一个到<em>M</em>的连接，当<em>M</em>收到请求之后，跟HTTP请求代理一样，对请求信息做一些修改，然后去目标服务器请求资源并返回给客户端。</p>
<h3 id="https_1">HTTPS证书生成</h3>
<p>在SSL/TLS握手过程中，客户端发送的第一个消息（Client Hello）中，会使用<a href="https://en.wikipedia.org/wiki/Server_Name_Indication">SNI(Server Name Indication
)</a>扩展，将请求的域名发送给服务器。虽然只发送了域名信息，并没有发送其他的请求路径、参数和cookie等信息，但是对于生成证书来说，有域名已经足够。</p>
<p>当hiproxy获取到请求的域名时：</p>
<ul>
<li>如果用户给对应的域名配置了证书，将用户配置的证书发送给客户端。</li>
<li>否则，生成新的域名证书返回给客户端。</li>
</ul>
<h3 id="_5">浏览器窗口</h3>
<p>首先，找到系统中浏览器对应的路径。比如在OSX上，查找<code>&lt;browser-name&gt;.app</code>，然后启动这个app，并传入参数来配置代理服务器地址。</p>
<pre><code class="bash">&lt;path-to-chrome-app&gt;.app [options] [url]
</code></pre>

<p>在windows上，会去注册表中查找对应浏览器的<code>exe</code>文件路径。然后运行并传递参数。</p>
<pre><code class="bash">&lt;path-to-chrome-app&gt;.exe [options] [url]
</code></pre>

<p>对于Chrome/Opera浏览器来说，我们需要传递两个方面的参数：</p>
<ul>
<li>
<p><strong>代理服务的地址</strong>：<code>--proxy-pac-url</code>（PAC代理文件路径）和<code>--proxy-server</code>（普通代理地址）二选一，这两种代理hiproxy都支持。</p>
</li>
<li>
<p><strong>用户数据存放的目录</strong>：<code>--user-data-dir</code>当传递这个参数，并且这个目录不是浏览器默认存放用户数据的目录，则会新建一个新的浏览器实例，这个示例独立于其他的浏览器窗口，互不影响（这个实例配置了代理，其他浏览器实例的请求不会通过这里配置的代理）。</p>
</li>
</ul>
<h3 id="_6">配置文件</h3>
<p>hiproxy可以使用hosts来做简单的请求代理，对于复杂的配置使用跟Nginx语法类似的rewrite规则配置。</p>
<h4 id="hosts">hosts</h4>
<p>跟系统<code>hosts</code>语法一致，此外也支持端口号。hosts只能配置域名对应的ip和端口号，不支持详细的路由配置以及对请求响应做修改。更多详细信息请查看<a href="../../configuration/hosts/">hosts</a>。</p>
<h4 id="hosts_1">hosts配置示例</h4>
<pre><code class="bash"># comment
127.0.0.1 example.com

# ip + port
127.0.0.1:8800 blog.example.com life.example.com
</code></pre>

<h4 id="rewrite">rewrite</h4>
<p>rewrite规则配置文件，可以使用更复杂的配置、满足复杂的使用场景。可以对路由进行详细的配置以及对请求响应做修改。rewrite规则配置的语法，跟Nginx语法非常类似。更多详细信息请查看<a href="../../configuration/rewrite/">rewrite</a>。</p>
<h4 id="rewrite_1">rewrite配置示例</h4>
<pre><code class="bash"># 全局变量
set $port 8899;
set $ip   127.0.0.1;
set $online 210.0.0.0;

# 域名配置
domain example.com {
  location / {
    proxy_pass http://$online/;
  }

  location /blog/ {
    proxy_pass http://$ip:$port/blog/;
    proxy_set_header from 'hiproxy';
    set_header proxy 'hiproxy';
  }
}
</code></pre>

<h3 id="_7">插件机制</h3>
<p>hiproxy启动的时候，会自动从npm全局模块所在目录（<code>npm root -g</code>）查找以<code>hiproxy-plugin-</code>开头的模块，找到这些模块之后自动解析插件内容。</p>
<p>因此，我们只需要独立全局安装需要的插件，不用去升级hiproxy，hiproxy插件的开发也是独立的，插件项目本身不依赖hiproxy。</p>
<p>详细的插件相关文档请查看<a href="../../developer/plugin/">hiproxy插件机制</a>；</p></div>
        </div>

        <footer class="col-md-12">
            <!-- <hr>
            <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p> -->
            <!-- <p>
              <a href="index.html#introduction" target="_blank">Documents</a> | <a href="https://github.com/hiproxy/hiproxy" target="_blank">GitHub Repo</a>
            </p>
            <p>
              <a href="https://twitter.com/intent/tweet?button_hashtag=hiproxy" class="twitter-hashtag-button" data-related="zhangdaiying" data-url="http://hiproxy.org">Tweet #hiproxy</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
              <a href="https://twitter.com/intent/tweet?screen_name=zhangdaiying" class="twitter-mention-button" data-related="zhangdaiying">Tweet to @zhangdaiying</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
              <a href="https://twitter.com/zhangdaiying" class="twitter-follow-button" data-show-count="false">Follow @zhangdaiying</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>  
            </p> -->
        </footer>
        <script>var base_url = '../..';</script>
        <script data-main="../../mkdocs/js/search.js" src="../../mkdocs/js/require.js"></script>
        <script src="../../js/base.js"></script><div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>
    </body>
</html>
